# .github/workflows/sync-cnb.yml

name: Sync to CNB
on: [push]

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      CNB_TOKEN: ${{ secrets.GIT_PASSWORD }}
      CNB_URL: "cnb.cool/2x.nz/fuwari.git"
      REPO_ZIP_URL: "https://github.com/afoim/fuwari/archive/refs/heads/main.zip"
      # 强制 Git 在需要输入时报错，而不是卡住
      GIT_TERMINAL_PROMPT: 0

    steps:
      - name: 1. Download Source ZIP
        run: curl -L -s "$REPO_ZIP_URL" -o repo.zip

      - name: 2. Extract ZIP
        run: unzip -q repo.zip

      - name: 3. Identify Source Directory
        id: identify
        run: |
          DIR_NAME=$(find . -maxdepth 1 -type d -name "fuwari-*" | head -n 1)
          echo "DIR_NAME=$DIR_NAME" >> $GITHUB_ENV
          echo "Found directory: $DIR_NAME"

      - name: 4. Initialize New Git Repository
        working-directory: ${{ env.DIR_NAME }}
        run: |
          git init -q
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 5. Configure CNB Remote
        working-directory: ${{ env.DIR_NAME }}
        # 显式使用带有凭据的 URL
        run: git remote add origin "https://cnb:${CNB_TOKEN}@${CNB_URL}"

      - name: 6. Create Sync Commit
        working-directory: ${{ env.DIR_NAME }}
        run: |
          git checkout -b main -q
          git add .
          git commit -q -m "sync: commit from GitHub zip"

      - name: 7. Force Push to CNB
        working-directory: ${{ env.DIR_NAME }}
        env:
          # 开启详细的网络调试日志（如果还是卡住，从日志能看出卡在哪个环节）
          GIT_CURL_VERBOSE: 1
        # 使用 --progress 强制显示进度，即便不是在终端运行
        run: git push -f --progress origin main
