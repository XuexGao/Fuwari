name: 5PR Ownership Verification Init

on:
  workflow_run:
    workflows: ["4PR Link Availability Check"] # 必须和第四个 workflow 的 name 完全一致
    types:
      - completed
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  ownership-init:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize ownership verification
        uses: actions/github-script@v7
        with:
          script: |
            console.log("=== Ownership Verification Init Started ===");

            const pendingLabel = "所有权验证未完成";
            const runningLabel = "所有权验证进行中";

            function randomString(len = 8) {
              return Math.random().toString(36).substring(2, 2 + len);
            }

            async function processPR(prNumber) {

              console.log("Checking PR:", prNumber);

              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              const labels = pr.data.labels.map(l => l.name);
              console.log("Labels:", labels);

              if (!labels.includes(pendingLabel)) {
                console.log("Skip PR (no pending label)");
                return;
              }

              // 获取 PR 修改文件
              const files = await github.paginate(
                github.rest.pulls.listFiles,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                }
              );

              let jsonData = null;

              for (const file of files) {
                if (file.filename.endsWith(".json") && file.status !== "removed") {
                  console.log("Found JSON:", file.filename);

                  const content = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: file.filename,
                    ref: pr.data.head.sha
                  });

                  const buff = Buffer.from(content.data.content, 'base64');
                  jsonData = JSON.parse(buff.toString("utf8"));
                  break;
                }
              }

              if (!jsonData || !jsonData.url) {
                console.log("No valid JSON or url field.");
                return;
              }

              const siteUrl = jsonData.url.replace(/\/$/, "");
              const random = randomString();
              const verifyPath = `${siteUrl}/${random}.txt`;
              const prHash = pr.data.head.sha;

              const commentBody = [
                "基础检查已完成，需要所有权验证。",
                "",
                "请在您的网站创建以下文件：",
                "",
                verifyPath,
                "",
                "文件内容应为：",
                "",
                prHash,
                "",
                "若已准备好，请回复该 PR 以完成最终的验证流程。"
              ].join("\n");

              console.log("Posting comment...");

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });

              console.log("Switching labels...");

              // 删除旧标签
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: pendingLabel,
                });
              } catch (e) {
                console.log("Pending label not found.");
              }

              // 添加新标签
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [runningLabel],
              });

              console.log("Ownership verification initialized for PR #" + prNumber);
            }

            // 获取所有 open PR
            const prs = await github.paginate(
              github.rest.pulls.list,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
              }
            );

            console.log("Total open PRs:", prs.length);

            for (const pr of prs) {
              await processPR(pr.number);
            }

            console.log("=== Ownership Verification Init Finished ===");
