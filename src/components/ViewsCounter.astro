---
import { Icon } from "astro-icon/components";

import { Translation, i18n } from "../i18n/translation";

type Props = {
	pathname: string;
	suffix?: string;
	id?: string;
};

const { pathname, suffix = i18n(Translation.Views, undefined) } = Astro.props;
const id =
	Astro.props.id ?? `page-views-${pathname.replace(/[^a-zA-Z0-9]+/g, "-")}`;
---

<div class="flex items-center">
	<div class="meta-icon">
		<Icon name="material-symbols:visibility-outline-rounded" class="text-xl" />
	</div>
	<span class="text-50 text-sm font-medium" id={id}>0 {suffix}</span>
</div>

<script define:vars={{ pathname, id }}>
	async function loadViews() {
		const el = document.getElementById(id);
		if (!el) return;
        const suffix = " " + window.i18n(window.Translation.Views);
		try {
			const res = await fetch(
				"https://t.2x.nz/share?pathname=" + encodeURIComponent(pathname),
			);
			if (!res.ok) return;
			const data = await res.json();
			const views = data?.views || 0;
			const current = Number.parseInt(el.textContent || "0", 10) || 0;
			if (current === 0) animateValueWithSuffix(el, 0, views, 1000, suffix);
			else el.innerHTML = views + " " + suffix;
		} catch {}
	}

	if (document.readyState === "loading")
		document.addEventListener("DOMContentLoaded", loadViews);
	else loadViews();
	document.addEventListener("astro:after-swap", loadViews);
	document.addEventListener("content:replace", loadViews);
	document.addEventListener("swup:contentReplaced", loadViews);
</script>
