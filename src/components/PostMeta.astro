---
import { Icon } from "astro-icon/components";

import { umamiConfig } from "../config";
import { formatPostDateForDisplay } from "../utils/date-utils";
import { url, getDir } from "../utils/url-utils";

interface Props {
	class: string;
	published: Date;
	updated?: Date;
	hideUpdateDate?: boolean;
	hidePublishedDate?: boolean;
	slug?: string;
}
const {
	published,
	updated,
	hideUpdateDate = false,
	hidePublishedDate = false,
	slug,
} = Astro.props;
const className = Astro.props.class;
---

<div class:list={["flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2", className]}>
    {!hidePublishedDate && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:schedule-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatPostDateForDisplay(published)}</span>
        </div>
    )}

    {!hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
        <div class="flex items-center">
            <div class="meta-icon"
            >
                <Icon name="material-symbols:edit-calendar-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatPostDateForDisplay(updated)}</span>
        </div>
    )}

    {slug && (
        <>
            <div class="flex items-center">
                <div class="meta-icon">
                    <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
                </div>
                <span class="text-50 text-sm font-medium" id={`page-views-${slug}`}>0 次</span>
            </div>
            </>
    )}
</div>

{slug && (
    <script define:vars={{ slug: slug }}>
    // 动画函数：支持后缀
    function animateValue(obj, start, end, duration, suffix = "") {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            // 实时显示：当前数字 + 后缀
            obj.innerHTML = Math.floor(progress * (end - start) + start) + suffix;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end + suffix;
            }
        };
        window.requestAnimationFrame(step);
    }

    async function fetchPageViews() {
        const websiteId = "4696c062-4271-4b8b-8ed7-b481f5961f28"; 
        const baseUrl = "https://u.xiegao.top";
        const shareId = "IoWiNCvTUPxaDg5x";

        try {
            const tokenRes = await fetch(`${baseUrl}/api/share/${shareId}`);
            if (!tokenRes.ok) return;
            const tokenData = await tokenRes.json();
            const token = tokenData.token;

            const url = `${baseUrl}/api/websites/${websiteId}/stats?path=/posts/${slug}/&startAt=0&endAt=${Date.now()}`;
            const response = await fetch(url, {
                headers: { 'x-umami-share-token': token }
            });
            if (!response.ok) return;
            const data = await response.json();
            
            const viewsElement = document.getElementById(`page-views-${slug}`);
            if (viewsElement) {
                let views = 0;
                if (typeof data.pageviews === 'number') {
                    views = data.pageviews;
                } else if (data.pageviews && data.pageviews.value) {
                    views = data.pageviews.value;
                }

                // 直接写死后缀，删掉那堆繁琐的 window.i18n 判断
                let suffix = " 次";

                // 【核心修改】调用动画，把 suffix (后缀) 传进去
                animateValue(viewsElement, 0, views, 800, suffix);
            }
        } catch (error) {
            console.warn('Umami PV fetch failed.', error);
        }
    }

    function initStats() { fetchPageViews(); }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initStats);
    } else {
        initStats();
    }
    document.addEventListener('swup:contentReplaced', initStats);
</script>
)}