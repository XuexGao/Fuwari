---
import { getCollection, getEntry } from 'astro:content';
import MainGridLayout from '../../layouts/MainGridLayout.astro';
import PostMetadata from '../../components/PostMetadata.astro';
import Icon from 'astro-icon/components';
import { i18n } from '../../i18n/translation';
import I18nKey from '../../i18n/i18nKey';
import Markdown from '../../components/Markdown.astro';

export async function getStaticPaths() {
    const posts = await getCollection('posts');
    return posts.map(entry => {
        // 移除语言前缀以匹配动态路由 [...slug]
        const slug = entry.slug.startsWith('en/') ? entry.slug.substring(3) : entry.slug;
        return {
            params: { slug },
            props: { entry }
        };
    });
}

const { entry } = Astro.props;
const { slug } = Astro.params;

// 渲染 Markdown 内容
const { Content, headings, remarkPluginFrontmatter } = await entry.render();

// 简单的 JSON-LD 数据
const jsonLd = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": entry.data.title,
    "description": entry.data.description,
    "author": { "@type": "Person", "name": "YourName" } // 这里可以改成你的名字
};
---

<MainGridLayout 
    banner={entry.data.image} 
    title={entry.data.title} 
    description={entry.data.description} 
    lang={entry.data.lang} 
    setOGTypeArticle={true} 
    headings={headings}
>
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
        <div id="post-container" class:list={["card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full", {}]}>
            <div class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation">
                <div class="flex flex-row items-center">
                    <Icon name="material-symbols:notes-rounded" class="mr-2"></Icon>
                    <div class="text-sm">{remarkPluginFrontmatter.words} {i18n(I18nKey.words)}</div>
                </div>
                <div class="flex flex-row items-center">
                    <Icon name="material-symbols:schedule-outline-rounded" class="mr-2"></Icon>
                    <div class="text-sm">{remarkPluginFrontmatter.minutes} {i18n(I18nKey.minutes)}</div>
                </div>
            </div>

            <div class="relative onload-animation">
                <div data-pagefind-body data-pagefind-weight="10" data-pagefind-meta="title" class="transition w-full flex items-center font-bold mb-3 text-3xl md:text-[2.25rem]/[2.75rem] text-black/90 dark:text-white/90">
                    {entry.data.title}
                </div>
            </div>

            <PostMetadata class="mb-5" published={entry.data.published} updated={entry.data.updated} tags={entry.data.tags} slug={entry.slug}></PostMetadata>

            <Markdown class="mb-6 markdown-content onload-animation">
                <Content />
            </Markdown>

            <div id="giscus-container" class="giscus"></div>
        </div>
    </div>
</MainGridLayout>

<script is:inline define:vars={{ slug }}>
    // 自动重定向逻辑
    const lang = navigator.language.toLowerCase().startsWith('en') ? 'en' : 'zh-cn';
    // 避免循环重定向
    if (!window.location.pathname.includes(`/${lang}/`)) {
        window.location.href = `/${lang}/posts/${slug}/`;
    }
</script>