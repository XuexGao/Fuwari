---
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
    const posts = await getCollection('posts');
    const slugs = new Set();
    posts.forEach(post => {
        let slug = post.slug;
        if (slug.startsWith('en/')) {
            slug = slug.substring(3);
        }
        slugs.add(slug);
    });
    
    return Array.from(slugs).map(slug => ({
        params: { slug },
        props: { slug }
    }));
}

const { slug } = Astro.params;
---
<MainGridLayout banner={entry.data.image} title={entry.data.title} description={entry.data.description} lang={entry.data.lang} setOGTypeArticle={true} headings={headings}>
    <script is:inline slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
        <div id="post-container" class:list={["card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full", {}]}>
            <div class="flex flex-row text-black/30 dark:text-white/30 gap-5 mb-3 transition onload-animation">
                <div class="flex flex-row items-center">
                    <Icon name="material-symbols:notes-rounded" class="mr-2"></Icon>
                    <div class="text-sm">{remarkPluginFrontmatter.words} <I18n key={Translation.words} /></div>
                </div>
                <div class="flex flex-row items-center">
                    <Icon name="material-symbols:schedule-outline-rounded" class="mr-2"></Icon>
                    <div class="text-sm">{remarkPluginFrontmatter.minutes} <I18n key={Translation.minutes} /></div>
                </div>
            </div>

            <div class="relative onload-animation">
                <div data-pagefind-body data-pagefind-weight="10" data-pagefind-meta="title" class="transition w-full flex items-center font-bold mb-3 text-3xl md:text-[2.25rem]/[2.75rem] text-black/90 dark:text-white/90">
                    {entry.data.title}
                </div>
            </div>

            <PostMetadata class="mb-5" published={entry.data.published} updated={entry.data.updated} tags={entry.data.tags} slug={entry.slug}></PostMetadata>

            <Markdown class="mb-6 markdown-content onload-animation">
                <Content />
            </Markdown>

            <div id="giscus-container"
                data-repo="XuexGao/Fuwari"
                data-repo-id="R_kgDORKqH6w"
                data-category="Announcements"
                data-category-id="DIC_kwDORKqH684C2CSW"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="zh-CN"
                data-loading="lazy"
                class="giscus"></div>
        </div>
    </div>
</MainGridLayout>

<script is:inline define:vars={{ slug }}>
    // 强制重定向到带语言路径的新地址 (上游最新规范)
    const lang = navigator.language.toLowerCase().startsWith('en') ? 'en' : 'zh-cn';
    window.location.href = `/${lang}/posts/${slug}/`;
</script>