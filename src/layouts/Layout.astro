---
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import { profileConfig, siteConfig } from "@/config";
import ConfigCarrier from "@components/ConfigCarrier.astro";
import NewPostNotification from "@components/widget/NewPostNotification.astro";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { url, pathsEqual } from "../utils/url-utils";
import "katex/dist/katex.css";
import { en } from "../i18n/languages/en";
import { zh_CN } from "../i18n/languages/zh_CN";
import { Translation, i18n } from "../i18n/translation";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, description, lang, setOGTypeArticle } = Astro.props;

if (!lang) {
	lang = `${siteConfig.lang}`;
}

const siteTitle = i18n(Translation.SiteTitle, lang);
const siteDescription = i18n(Translation.SiteDescription, lang);
const authorName = i18n(Translation.AuthorName, lang);
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));
const configHue = siteConfig.themeColor.hue;

if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = siteConfig.banner.src;
}
banner = siteConfig.banner.src;
const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteTitle}`;
} else {
	pageTitle = (siteConfig.subtitle && siteConfig.subtitle.trim() !== "") ? `${siteTitle} - ${siteConfig.subtitle}` : siteTitle;
}

if (!description) {
	description = siteDescription || pageTitle;
}

const favicons: Favicon[] = siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset = bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[12px] md:text-[16px] dark">
	<head>
		<title>{pageTitle}</title>
		<link rel="canonical" href={Astro.url}>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="description" content={description}>
		<meta name="author" content={authorName}>
		{siteConfig.keywords && (
			<meta name="keywords" content={siteConfig.keywords.join(", ")}>
		)}

		<meta property="og:site_name" content={siteTitle}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description}>
		<meta property="og:type" content={setOGTypeArticle ? "article" : "website"} />

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description}>
		<meta name="generator" content={Astro.generator} />

        <link rel="preconnect" href="https://pic1.acofork.com" />
        <link rel="preconnect" href="https://umami.acofork.com" />
        <link rel="preconnect" href="https://u.xiegao.top" />
		
		<script>import "../scripts/animate-value.js";</script>

        <script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-P8V8663M');</script>

		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

<<<<<<< HEAD
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue, forceDarkMode: siteConfig.themeColor.forceDarkMode}}>
			if (forceDarkMode) {
				document.documentElement.classList.add('dark');
				localStorage.setItem('theme', DARK_MODE);
			} else {
    			const theme = localStorage.getItem('theme') || DARK_MODE;
    			if (theme === LIGHT_MODE) document.documentElement.classList.remove('dark');
    			else if (theme === DARK_MODE) document.documentElement.classList.add('dark');
    			else if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
			}
=======
		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DARK_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue}}>
			// Force dark mode
			document.documentElement.classList.add('dark');
			localStorage.setItem('theme', DARK_MODE);

			// Load the hue from local storage
>>>>>>> upstream/main
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
		</script>
        
        <script define:vars={{ en, zh_CN, Translation }}>
            window.Translation = Translation;
            window.translations = { en, zh_CN };
            window.i18n = function(key, l) {
                const currentLang = l || document.documentElement.getAttribute('lang')?.replace('-', '_') || 'zh_CN';
                return window.translations[currentLang][key];
            };
        </script>
        
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
			'bg-url': siteConfig.background.src ? `url(${siteConfig.background.src})` : 'none',
			'bg-enable': siteConfig.background.enable ? '1' : '0',
			'bg-position': siteConfig.background.position || 'center',
			'bg-size': siteConfig.background.size || 'cover',
			'bg-repeat': siteConfig.background.repeat || 'no-repeat',
			'bg-attachment': siteConfig.background.attachment || 'fixed',
			'bg-opacity': (siteConfig.background.opacity || 0.3).toString()
		}}>
			:root { --hue: var(--configHue); --page-width: var(--page-width); }
			#bg-box {
				position: fixed; top: 0; left: 0; width: 100%; height: 100%;
				background-image: var(--bg-url); background-position: var(--bg-position);
				background-size: var(--bg-size); background-repeat: var(--bg-repeat);
				background-attachment: var(--bg-attachment); 
                /* 直接赋值透明度，拒绝强制隐身 */
                opacity: calc(var(--bg-opacity) * var(--bg-enable));
				pointer-events: none; z-index: -1; 
                will-change: transform; transform: translateZ(0);
			}
			#bg-box.loaded { opacity: calc(var(--bg-opacity) * var(--bg-enable)); }
		</style>

		<slot name="head"></slot>
		<link rel="alternate" type="application/rss+xml" title={authorName} href={new URL(url('rss.xml', lang === 'zh_CN' ? 'zh-cn' : 'en'), Astro.site)}/>
	</head>

	<body class:list={["min-h-screen transition", {"lg:is-home": isHomePage, "enable-banner": enableBanner}]}>
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P8V8663M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<<<<<<< HEAD
        <script defer src="https://u.xiegao.top/script.js" data-website-id="4696c062-4271-4b8b-8ed7-b481f5961f28" data-swup-ignore-script></script>

        <script is:inline data-swup-ignore-script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a87028bb5a1ed77d98f192bc12b56142";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
        </script>
=======
<!-- Cookie Consent by TermsFeed https://www.TermsFeed.com -->
<script data-swup-ignore-script type="text/javascript" src="https://www.termsfeed.com/public/cookie-consent/4.2.0/cookie-consent.js" charset="UTF-8"></script>
<script data-swup-ignore-script type="text/javascript" charset="UTF-8">
(function () {
	const getStoredTheme = () => {
		return "dark";
	};

	const getPalette = () => {
		return "dark";
	};
>>>>>>> upstream/main

        <script data-swup-ignore-script async src="https://www.googletagmanager.com/gtag/js?id=G-RBZVQJCV26"></script>
        <script is:inline data-swup-ignore-script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RBZVQJCV26');
        </script>

		<div id="bg-box"></div>
		<ConfigCarrier></ConfigCarrier>
		<slot />
		<div id="page-height-extend" class="hidden h-[300vh]"></div>
<<<<<<< HEAD
=======

		<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
>>>>>>> upstream/main
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
}
</style>

<script>
import {getHue, getStoredTheme, setHue, setTheme, getBgBlur, setBgBlur, getHideBg, setHideBg} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import { bindPostInlineDiff } from "../scripts/post-inline-diff";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

const bannerEnabled = !!document.getElementById('banner-wrapper')

function setClickOutsideToClose(panel: string, ignores: string[]) {
	document.addEventListener("click", event => {
		let panelDom = document.getElementById(panel);
		let tDom = event.target;
		if (!(tDom instanceof Node)) return;
		for (let ig of ignores) {
			let ie = document.getElementById(ig)
			if (ie == tDom || (ie?.contains(tDom))) return;
		}
		panelDom!.classList.add("float-panel-closed");
	});
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])

function loadTheme() { setTheme(getStoredTheme()) }
function loadHue() { setHue(getHue()) }
function loadBgBlur() { setBgBlur(getBgBlur()); setHideBg(getHideBg()); }

function showBanner() {
	if (!siteConfig.banner.enable) return;
	const banner = document.getElementById('banner');
	if (!banner) return;
	banner.classList.remove('opacity-0', 'scale-105');
}

function loadGiscus() {
	const container = document.getElementById('giscus-container');
	if (!container) return;
	if (container.querySelector('iframe.giscus-frame') || container.querySelector('script[src*="giscus"]')) return;

	const script = document.createElement('script');
	script.src = "https://giscus.app/client.js";
	const attributes = [
		"data-repo", "data-repo-id", "data-category", "data-category-id",
		"data-mapping", "data-strict", "data-reactions-enabled",
		"data-emit-metadata", "data-input-position", "data-lang", "data-loading"
	];
	attributes.forEach(attr => {
		const val = container.getAttribute(attr);
		if (val) script.setAttribute(attr, val);
	});
<<<<<<< HEAD
	script.setAttribute("data-theme", document.documentElement.classList.contains('dark') ? 'dark' : 'light');
	const giscusLang = (localStorage.getItem('lang') || 'zh_CN') === 'zh_CN' ? 'zh-CN' : 'en';
	script.setAttribute("data-lang", giscusLang);
=======
	script.setAttribute("data-theme", 'dark');
>>>>>>> upstream/main
	script.crossOrigin = "anonymous";
	script.async = true;

	container.appendChild(script);
}

function init() {
	loadTheme();
	loadHue();
    loadBgBlur();
	showBanner();
	loadGiscus();

	new MutationObserver(() => {
		const frame = document.querySelector('iframe.giscus-frame') as HTMLIFrameElement;
		if (!frame) return;
<<<<<<< HEAD
		const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
		const lang = document.documentElement.getAttribute('lang') === 'zh-CN' ? 'zh-CN' : 'en';
		frame.contentWindow?.postMessage({ giscus: { setConfig: { theme, lang } } }, 'https://giscus.app');
	}).observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'lang'] });
=======
		frame.contentWindow.postMessage({ giscus: { setConfig: { theme: 'dark' } } }, 'https://giscus.app');
	}).observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
	// console.timeEnd("init");
>>>>>>> upstream/main
}

init();
bindPostInlineDiff();

const setup = () => {
	window.swup.hooks.on('link:click', () => {
		document.documentElement.style.setProperty('--content-delay', '0ms')
		if (!bannerEnabled) return
		let threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 72 - 16
		let navbar = document.getElementById('navbar-wrapper')
		if (!navbar || !document.body.classList.contains('lg:is-home')) return
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		}
	})
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		const bodyElement = document.querySelector('body')
		if (pathsEqual(visit.to.url, url('/'))) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) heightExtend.classList.remove('hidden')
		let toc = document.getElementById('toc-wrapper');
		if (toc) toc.classList.add('toc-not-ready')
	});
	window.swup.hooks.on('page:view', () => {
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) heightExtend.classList.remove('hidden')
		scrollFunction()
		loadGiscus()
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) heightExtend.classList.add('hidden')
            const toc = document.getElementById('toc-wrapper');
            if (toc) toc.classList.remove('toc-not-ready')
        }, 200)
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let goToCommentsBtn = document.getElementById('go-to-comments-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')
function refreshControlRefs() {
	backToTopBtn = document.getElementById('back-to-top-btn');
	goToCommentsBtn = document.getElementById('go-to-comments-btn');
	toc = document.getElementById('toc-wrapper');
	navbar = document.getElementById('navbar-wrapper')
}
function scrollFunction() {
	refreshControlRefs()
	let bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100)

	if (backToTopBtn) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			backToTopBtn.classList.remove('hide')
		} else {
			backToTopBtn.classList.add('hide')
		}
	}

    if (goToCommentsBtn) {
        const commentsExist = !!document.getElementById('giscus-container');
        if (commentsExist) {
            goToCommentsBtn.classList.remove('hide')
        } else {
            goToCommentsBtn.classList.add('hide')
        }
    }

	if (bannerEnabled && toc) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			toc.classList.remove('toc-hide')
		} else {
			toc.classList.add('toc-hide')
		}
	}

	if (!bannerEnabled) return
	if (navbar) {
		const NAVBAR_HEIGHT = 72
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * 16			
		let bannerHeight = BANNER_HEIGHT
		if (document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024) {
			bannerHeight = BANNER_HEIGHT_HOME
		}
		let threshold = window.innerHeight * (bannerHeight / 100) - NAVBAR_HEIGHT - MAIN_PANEL_EXCESS_HEIGHT - 16
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		} else {
			navbar.classList.remove('navbar-hidden')
		}
	}
}
window.onscroll = scrollFunction
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', scrollFunction)
} else {
	scrollFunction()
}
window.onresize = () => {
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}
</script>

<script>
import { Fancybox } from "@fancyapps/ui"
import "@fancyapps/ui/dist/fancybox/fancybox.css"

const setup = () => {
	const cleanupFancybox = () => {
		try { Fancybox.close() } catch {}
		document.querySelectorAll('.fancybox__container').forEach(el => el.remove())
		document.documentElement.style.removeProperty('overflow')
		document.body.style.removeProperty('overflow')
	}
	const restoreNativeScrollIfSafe = () => {
		const hasFancybox = !!document.querySelector('.fancybox__container')
		if (hasFancybox) return
		document.documentElement.style.removeProperty('overflow')
		document.body.style.removeProperty('overflow')
	}

	Fancybox.bind(".custom-md img, #post-cover img", {
		wheel: 'zoom', clickContent: 'close', dblclickContent: 'zoom', click: 'close', dblclick: 'zoom',
		Panels: { display: ['counter', 'zoom'] },
		Images: { panning: true, zoom: true, protect: false }
	})

	window.swup.hooks.on("page:view", () => {
		Fancybox.bind(".custom-md img, #post-cover img", {
			wheel: 'zoom', clickContent: 'close', dblclickContent: 'zoom', click: 'close', dblclick: 'zoom',
			Panels: { display: ['counter', 'zoom'] },
			Images: { panning: true, zoom: true, protect: false }
		})
	})

	window.swup.hooks.on("content:replace", () => {
		cleanupFancybox(); Fancybox.unbind(".custom-md img, #post-cover img")
	}, { before: true })

	window.swup.hooks.on("visit:start", () => { cleanupFancybox() }, { before: true })

	window.addEventListener('keydown', (e) => {
		if (e.key !== 'Escape') return
		setTimeout(restoreNativeScrollIfSafe, 0)
	})
	document.addEventListener('click', () => { setTimeout(restoreNativeScrollIfSafe, 0) }, true)
}

if (window.swup) {
	setup()
} else {
	document.addEventListener("swup:enable", setup)
}
</script>

<svg style="position: absolute; width: 0; height: 0; overflow: hidden;" aria-hidden="true">
  <defs>
    <filter id="liquid-glass">
      <feTurbulence type="fractalNoise" baseFrequency="0.05" numOctaves="2" result="noise" />
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" xChannelSelector="R" yChannelSelector="G" />
    </filter>
  </defs>
</svg>
